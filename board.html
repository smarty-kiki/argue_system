<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>辩论赛</title>
    <style>

     table {
         font-family: verdana,arial,sans-serif;
         font-size:11px;
         color:#333333;
         border-width: 0px;
         border-color: #666666;
         border-collapse: collapse;
         width: 100%;
     }
     table th {
         border-width: 1px;
         padding: 8px;
         border-style: solid;
         border-color: #666666;
         background-color: #dedede;
         text-align: center;
     }
     table td {
         border-width: 0px;
         padding: 8px;
         border-style: solid;
         border-color: #666666;
         background-color: #ffffff;
         text-align: center;
     }

    </style>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/qrcode.js"></script>
    <script src="/js/jquery.qrcode.js"></script>
</head>
<body>
    <table style="margin-bottom: 20px;">
        <tr>
            <td class="qrcode"></td>
        </tr>
        <tr>
            <td style="font-size: 55px; color: gray;" >
                <p> 一次扫码，随时改票 </p>
            </td>
        </tr>
    </table>

    <table style="margin-bottom: 20px;">
        <tbody>
            <tr>
                <td colspan="3" class="question" style="font-size: 100px;"></td>
            </tr>
            <tr>
                <td class="left" style="width: 50%; font-size: 75px; color: red;"></td>
                <td class="" style="font-size: 75px;"></td>
                <td class="right" style="width: 50%; font-size: 75px; color: blue;"></td>
            </tr>
        </tbody>
    </table>
    <table>
        <tbody>
            <tr style="height: 300px;">
                <td class="left-score" style="background-color: red; font-size: 100px; color: white;"></td>
                <td class="right-score" style="background-color: blue; font-size: 100px; color: white;"></td>
            </tr>
        </tbody>
    </table>
    <table class="input">
        <tr>
            <td><input class="seconds"> 输入秒数，按 ← 红方计时，按 → 蓝方计时，按 ↑ 进入红蓝双方切换计时按左右方向切换，所有计时方式按 ↓ 结束且记录分，按 ESC 取消计时</td>
        </tr>
    </table>
    <table class="left-timer">
        <tr>
            <td id="ltimer" style="font-size: 100px; color: red;"></td>
        </tr>
    </table>
    <table class="right-timer">
        <tr>
            <td id="rtimer" style="font-size: 100px; color: blue;"></td>
        </tr>
    </table>
    <table class="pk-timer">
        <tr>
            <td id="pkltimer" style="font-size: 100px; color: red;"></td>
            <td id="pkrtimer" style="font-size: 100px; color: blue;"></td>
        </tr>
    </table>
</body>
<script>

    var timers = [];

    $(function () {

        function getQueryVariable(variable, dft = 'default')
        {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
            }
            return dft;
        }

        function setScore(left, right)
        {
            var total = left + right;

            $('.left-score').css('width', Math.round(left / total * 100) + '%');
            $('.left-score').css('font-size', Math.round(left / total * 100 + 100) + 'px');
            $('.right-score').css('width', Math.round(right / total * 100) + '%');
            $('.right-score').css('font-size', Math.round(right / total * 100 + 100) + 'px');

            $('.left-score').text(left);
            $('.right-score').text(right);

            // shake shake-hard
        }

        $('.question').text(decodeURI(getQueryVariable('question', 'URL 参数 question 会显示在这里')));
        $('.left').text(decodeURI(getQueryVariable('left', '参数 left 会显示在这里')));
        $('.right').text(decodeURI(getQueryVariable('right', '参数 right 会显示在这里')));

        var rand = Math.round(Math.random() * 1000);
        var url = window.location.origin + '/vote.html?rand=' + rand;
        console.log(url);

        $('.qrcode').qrcode({
            text: url,
            width: 300, //宽度
            height:300, //高度
            color : "#aaaaaa"
        });

        var ws = new WebSocket('ws://center.yao-yang.cn:50000/' + rand);

        ws.onmessage = function (event) {
            if (typeof event.data === 'string') {
                var vote_result = JSON.parse(event.data);
                setScore(vote_result.left, vote_result.right);
                console.log(vote_result.vote_infos);
            }
        };

        ws.onopen = function () {
            ws.send(JSON.stringify({
                total: getQueryVariable('total', 37),
            }));
        };

        var timer = function (id, seconds) {

            var dom = document.getElementById(id);
            var res = {};
            var t = null;

            res.display = function () {
                var m = Math.floor(seconds / 60);
                var s = seconds % 60;
                dom.innerHTML =
                    (m > 0) ?
                    m + '′' + s + '″':
                    s + '″';
            }

            res.display();

            res.reduce = function () {
                seconds -= 1;
                if (seconds < 0) {
                    seconds = 0;
                }
                res.display();
            }

            res.start = function () {
                if (t === null) {
                    t = setInterval(function () {
                        res.reduce();
                        if (res.is_finished()) {
                            clearInterval(t);
                        }
                    }, 1000);
                }
            }

            res.pause = function () {
                clearInterval(t);
            }

            res.is_finished = function () {
                return seconds === 0;
            }

            return res;
        }

        var timer_status = 'input';

        function showkey() {

            var key = event.keyCode;

            if (timer_status === 'input') {
                if (key == 37) {

                    $('.input').hide();
                    timer_status = 'left-timer';
                    timers['left-timer'] = timer('ltimer', $('.seconds').val());
                    timers['left-timer'].start();
                    $('.left-timer').show();

                } else if (key == 39) {

                    $('.input').hide();
                    timer_status = 'right-timer';
                    timers['right-timer'] = timer('rtimer', $('.seconds').val());
                    timers['right-timer'].start();
                    $('.right-timer').show();

                } else if (key == 38) {

                    $('.input').hide();
                    timer_status = 'pk-timer';
                    timers['pk-left-timer'] = timer('pkltimer', $('.seconds').val());
                    timers['pk-right-timer'] = timer('pkrtimer', $('.seconds').val());
                    $('.pk-timer').show();
                }
            } else {

                if (key == 27) {
                    if (timer_status == 'left-timer') {
                        timers['left-timer'].pause();
                        $('.left-timer').hide();
                        $('.input').show();
                        timer_status = 'input';
                    }
                    if (timer_status == 'right-timer') {
                        timers['right-timer'].pause();
                        $('.right-timer').hide();
                        $('.input').show();
                        timer_status = 'input';
                    }
                    if (timer_status == 'pk-timer') {
                        timers['pk-left-timer'].pause();
                        timers['pk-right-timer'].pause();
                        $('.pk-timer').hide();
                        $('.input').show();
                        timer_status = 'input';
                    }
                } else if (key == 40) {

                } else if (timer_status == 'pk-timer') {

                    if (key == 37) {

                        timers['pk-right-timer'].pause();
                        timers['pk-left-timer'].start();

                    } else if (key == 39) {

                        timers['pk-left-timer'].pause();
                        timers['pk-right-timer'].start();
                    }
                }
                //if (key == 40) alert("按了↓键！");
            }
            //if (key == 37) alert("按了←键！");
            //if (key == 39) alert("按了→键！");
            //if (key == 38) alert("按了↑键！");
        }

        document.onkeydown = showkey;
    });

</script>
</html>
